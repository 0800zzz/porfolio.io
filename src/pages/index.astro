---
import Layout from "@/layouts/Layout.astro";
import Section from "@/components/Section.astro";
import BlogPostCard from "@/components/BlogPostCard.astro";
import Hero from "@/components/Hero.astro";
import Stats from "@/components/Stats.astro";
import Terminal from "@/components/Terminal.astro";
import Certs from "@/components/Certs.astro";

import { ABOUT_ME } from "@/consts";
import { getCollection } from "astro:content";

const BASE: string = import.meta.env.BASE_URL || "/";

// join seguro
const join = (...segs: string[]) =>
  "/" +
  segs
    .map(s => String(s ?? "").replace(/^\/+|\/+$/g, ""))
    .filter(Boolean)
    .join("/") +
  "/";

// posts
let posts: any[] = [];
try { posts = await getCollection("blog"); } catch { posts = []; }

posts = posts
  .filter((p) => !p.data.draft)
  .sort((a, b) => {
    const ad = a?.data?.pubDate ? new Date(a.data.pubDate).valueOf() : 0;
    const bd = b?.data?.pubDate ? new Date(b.data.pubDate).valueOf() : 0;
    return bd - ad;
  });

const latest = posts.slice(0, 6);
---

<Layout title="porfolio.io">

  <!-- HERO -->
  <Hero
    title="Emiliano Carrizo"
    subtitle="Pentesting • Purple Team • Writeups"
    matrix={true}
  />

  <!-- STATS -->
  <Section id="stats">
    <Stats />
  </Section>

  <!-- WHOAMI -->
  <Section id="whoami" title="whoami">
    <div class="mx-auto max-w-3xl text-white/80 text-left leading-relaxed font-mono">
      <p>{ABOUT_ME}</p>
    </div>
  </Section>

  <!-- WRITEUPS -->
  <Section id="writeups" title="ls /writeups">
    {latest.length === 0 ? (
      <p class="text-center text-white/60 font-mono">
        Sin entradas aún.
      </p>
    ) : (
      <>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          {latest.map((p) => (
            <BlogPostCard
              href={join(BASE, "blog", p.slug ?? (p.id.split("/").pop() || ""))}
              title={p.data.title}
              description={p.data.description}
              date={p.data.pubDate}
              tags={p.data.tags}
              heroImage={p.data.heroImage}
            />
          ))}
        </div>

        <div class="mt-6 text-center">
          <a
            href={join(BASE, "blog")}
            class="inline-block font-mono text-xs text-emerald-300
                   border border-emerald-400/30 rounded px-3 py-2
                   hover:bg-emerald-400/10"
          >
            [ VER TODOS LOS POSTS ]
          </a>
        </div>
      </>
    )}
  </Section>

  <!-- SKILLS -->
  <Section id="skills" title="ls /skill">
    <div class="grid gap-8 md:grid-cols-3">

      <div class="rounded-xl border border-red-400/20 bg-black/40 p-5">
        <h3 class="mb-4 font-mono text-sm uppercase tracking-wide text-red-400">
          offensive / red team
        </h3>
        <div class="flex flex-wrap gap-2">
          {["Nmap", "Burp Suite", "Gobuster", "SQLmap", "Hydra"].map(t => (
            <span class="rounded-full border border-red-400/30 px-3 py-1 text-xs font-mono text-red-300">{t}</span>
          ))}
        </div>
      </div>

      <div class="rounded-xl border border-blue-400/20 bg-black/40 p-5">
        <h3 class="mb-4 font-mono text-sm uppercase tracking-wide text-blue-400">
          blue / purple team
        </h3>
        <div class="flex flex-wrap gap-2">
          {["Wazuh", "Splunk", "Wireshark"].map(t => (
            <span class="rounded-full border border-blue-400/30 px-3 py-1 text-xs font-mono text-blue-300">{t}</span>
          ))}
        </div>
      </div>

      <div class="rounded-xl border border-white/15 bg-black/40 p-5">
        <h3 class="mb-4 font-mono text-sm uppercase tracking-wide text-white/70">
          base / infra
        </h3>
        <div class="flex flex-wrap gap-2">
          {["Linux", "Bash", "Python", "Docker"].map(t => (
            <span class="rounded-full border border-white/20 px-3 py-1 text-xs font-mono text-white/70">{t}</span>
          ))}
        </div>
      </div>

    </div>
  </Section>

  <!-- CERTS -->
  <Section id="certs" title="certs">
    <Certs />
  </Section>

  <!-- TERMINAL -->
  <Section id="bash" title="bin/bash">
    <Terminal />
  </Section>

</Layout>
